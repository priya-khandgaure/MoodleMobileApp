"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[36553],{36553:(e,o,s)=>{s.r(o),s.d(o,{AddonModWorkshopSync:()=>b,AddonModWorkshopSyncProvider:()=>W});var r=s(10467),d=s(42008),n=s(49446),i=s(97254),t=s(94455),a=s(52749),l=s(48966),c=s(49588),u=s(43411),h=s(79555),p=s(49882),m=s(67193),f=s(80178),y=s(26327),k=s(81552),g=s(55554),A=s(54438);let W=(()=>{var e;class AddonModWorkshopSyncProvider extends d.l{constructor(){super("AddonModWorkshopSyncProvider"),this.componentTranslatableString="workshop"}hasDataToSync(e,o){return y.AddonModWorkshopOffline.hasWorkshopOfflineData(e,o)}syncAllWorkshops(e,o){return this.syncOnSites("all workshops",(e=>this.syncAllWorkshopsFunc(!!o,e)),e)}syncAllWorkshopsFunc(e,o){var s=this;return(0,r.A)((function*(){const d=(yield y.AddonModWorkshopOffline.getAllWorkshops(o)).map(function(){var d=(0,r.A)((function*(r){const d=e?yield s.syncWorkshop(r,o):yield s.syncWorkshopIfNeeded(r,o);d&&d.updated&&p.z.trigger(k.N7,{workshopId:r,warnings:d.warnings},o)}));return function(e){return d.apply(this,arguments)}}());yield Promise.all(d)}))()}syncWorkshopIfNeeded(e,o){var s=this;return(0,r.A)((function*(){if(yield s.isSyncNeeded(e,o))return s.syncWorkshop(e,o)}))()}syncWorkshop(e,o){o=o||a.CoreSites.getCurrentSiteId();const s=this.getOngoingSync(e,o);if(s)return s;if(l.CoreSync.isBlocked(k.Ug,e,o))throw this.logger.debug(`Cannot sync workshop '${e}' because it is blocked.`),new d.D(h.HT.instant("core.errorsyncblocked",{$a:this.componentTranslate}));this.logger.debug(`Try to sync workshop '${e}' in site ${o}'`);const r=this.performSyncWorkshop(e,o);return this.addOngoingSync(e,r,o)}performSyncWorkshop(e,o){var s=this;return(0,r.A)((function*(){const r={warnings:[],updated:!1};yield g.g.ignoreErrors(i.CoreCourseLogHelper.syncActivity(k.Ug,e,o));const d=yield Promise.all([g.g.ignoreErrors(y.AddonModWorkshopOffline.getSubmissions(e,o),[]),g.g.ignoreErrors(y.AddonModWorkshopOffline.getAssessments(e,o),[]),g.g.ignoreErrors(y.AddonModWorkshopOffline.getEvaluateSubmissions(e,o),[]),g.g.ignoreErrors(y.AddonModWorkshopOffline.getEvaluateAssessments(e,o),[])]);let a;for(const e in d)if(d[e].length>0&&d[e][0].courseid){a=d[e][0].courseid;break}if(!a)return yield g.g.ignoreErrors(s.setSyncTime(e,o)),r;if(!t.WE.isOnline())throw new n.CoreNetworkError;const l=yield m.AddonModWorkshop.getWorkshopById(a,e,{siteId:o}),c=d[1],u=d[2],h=d[3],p={},f=[];return d[0].forEach((e=>{p[e.submissionid]=p[e.submissionid]||[],p[e.submissionid].push(e)})),Object.keys(p).forEach((e=>{f.push(s.syncSubmission(l,p[e],r,o).then((()=>{r.updated=!0})))})),c.forEach((e=>{f.push(s.syncAssessment(l,e,r,o).then((()=>{r.updated=!0})))})),u.forEach((e=>{f.push(s.syncEvaluateSubmission(l,e,r,o).then((()=>{r.updated=!0})))})),h.forEach((e=>{f.push(s.syncEvaluateAssessment(l,e,r,o).then((()=>{r.updated=!0})))})),yield Promise.all(f),r.updated&&(yield g.g.ignoreErrors(m.AddonModWorkshop.invalidateContentById(e,a,o))),yield g.g.ignoreErrors(s.setSyncTime(e,o)),r}))()}syncSubmission(e,o,s,d){var n=this;return(0,r.A)((function*(){let i,t=0,a=(o=o.sort(((e,o)=>e.timemodified-o.timemodified)))[0].submissionid;if(a>0)try{t=(yield m.AddonModWorkshop.getSubmission(e.id,a,{cmId:e.coursemodule,siteId:d})).timemodified}catch{t=-1}if(t<0||t>=o[0].timemodified)return s.updated=!0,i=h.HT.instant("addon.mod_workshop.warningsubmissionmodified"),yield y.AddonModWorkshopOffline.deleteAllSubmissionActions(e.id,d),n.addOfflineDataDeletedWarning(s.warnings,e.name,i),void 0;yield Promise.all(o.map(function(){var o=(0,r.A)((function*(o){a=o.submissionid>0?o.submissionid:a;try{let s;if(o.attachmentsid){const r=yield f.AddonModWorkshopHelper.getSubmissionFilesFromOfflineFilesObject(o.attachmentsid,e.id,d);s=yield f.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.id,r,!1,d)}else s=yield f.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.id,[],!1,d);switch(0==e.submissiontypefile&&(s=void 0),o.action){case"add":a=yield m.AddonModWorkshop.addSubmissionOnline(e.id,o.title,o.content,s,d);break;case"update":yield m.AddonModWorkshop.updateSubmissionOnline(a,o.title,o.content,s,d);break;case"delete":yield m.AddonModWorkshop.deleteSubmissionOnline(a,d)}}catch(e){throw u.CoreWSError.isWebServiceError(e)&&(i=c.CoreErrorHelper.getErrorMessageFromError(e)),e}if(s.updated=!0,yield y.AddonModWorkshopOffline.deleteSubmissionAction(o.workshopid,o.action,d),"add"==o.action||"update"==o.action)return f.AddonModWorkshopHelper.deleteSubmissionStoredFiles(o.workshopid,d)}));return function(e){return o.apply(this,arguments)}}())),i&&n.addOfflineDataDeletedWarning(s.warnings,e.name,i)}))()}syncAssessment(e,o,s,d){var n=this;return(0,r.A)((function*(){let r;const i=o.assessmentid;let t=0;try{t=(yield m.AddonModWorkshop.getAssessment(e.id,i,{cmId:e.coursemodule,siteId:d})).timemodified}catch{t=-1}if(t<0||t>=o.timemodified)return s.updated=!0,r=h.HT.instant("addon.mod_workshop.warningassessmentmodified"),yield y.AddonModWorkshopOffline.deleteAssessment(e.id,i,d),n.addOfflineDataDeletedWarning(s.warnings,e.name,r),void 0;let a=0;const l=o.inputdata;try{let o=[];l.feedbackauthorattachmentsid&&"number"!=typeof l.feedbackauthorattachmentsid&&(o=yield f.AddonModWorkshopHelper.getAssessmentFilesFromOfflineFilesObject(l.feedbackauthorattachmentsid,e.id,i,d)),a=yield f.AddonModWorkshopHelper.uploadOrStoreAssessmentFiles(e.id,i,o,!1,d),l.feedbackauthorattachmentsid=a||0,yield m.AddonModWorkshop.updateAssessmentOnline(i,l,d)}catch(e){if(!u.CoreWSError.isWebServiceError(e))throw e;r=c.CoreErrorHelper.getErrorMessageFromError(e)}s.updated=!0,yield y.AddonModWorkshopOffline.deleteAssessment(e.id,i,d),yield f.AddonModWorkshopHelper.deleteAssessmentStoredFiles(e.id,i,d),r&&n.addOfflineDataDeletedWarning(s.warnings,e.name,r)}))()}syncEvaluateSubmission(e,o,s,d){var n=this;return(0,r.A)((function*(){let r;const i=o.submissionid;let t=0;try{t=(yield m.AddonModWorkshop.getSubmission(e.id,i,{cmId:e.coursemodule,siteId:d})).timemodified}catch{t=-1}if(t<0||t>=o.timemodified)return s.updated=!0,r=h.HT.instant("addon.mod_workshop.warningsubmissionmodified"),yield y.AddonModWorkshopOffline.deleteEvaluateSubmission(e.id,i,d),n.addOfflineDataDeletedWarning(s.warnings,e.name,r),void 0;try{yield m.AddonModWorkshop.evaluateSubmissionOnline(i,o.feedbacktext,o.published,o.gradeover,d)}catch(e){if(!u.CoreWSError.isWebServiceError(e))throw e;r=c.CoreErrorHelper.getErrorMessageFromError(e)}s.updated=!0,yield y.AddonModWorkshopOffline.deleteEvaluateSubmission(e.id,i,d),r&&n.addOfflineDataDeletedWarning(s.warnings,e.name,r)}))()}syncEvaluateAssessment(e,o,s,d){var n=this;return(0,r.A)((function*(){let r;const i=o.assessmentid;let t=0;try{t=(yield m.AddonModWorkshop.getAssessment(e.id,i,{cmId:e.coursemodule,siteId:d})).timemodified}catch{t=-1}if(t<0||t>=o.timemodified)return s.updated=!0,r=h.HT.instant("addon.mod_workshop.warningassessmentmodified"),y.AddonModWorkshopOffline.deleteEvaluateAssessment(e.id,i,d);try{yield m.AddonModWorkshop.evaluateAssessmentOnline(i,o.feedbacktext,o.weight,o.gradinggradeover,d)}catch(e){if(!u.CoreWSError.isWebServiceError(e))throw e;r=c.CoreErrorHelper.getErrorMessageFromError(e)}s.updated=!0,yield y.AddonModWorkshopOffline.deleteEvaluateAssessment(e.id,i,d),r&&n.addOfflineDataDeletedWarning(s.warnings,e.name,r)}))()}}return(e=AddonModWorkshopSyncProvider).ɵfac=function AddonModWorkshopSyncProvider_Factory(o){return new(o||e)},e.ɵprov=A.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModWorkshopSyncProvider})();const b=(0,h.Qd)(W)}}]);