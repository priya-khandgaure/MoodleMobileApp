"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[61781],{61781:(e,o,t)=>{t.r(o),t.d(o,{default:()=>$});var i=t(10467),s=t(89417),n=t(75629),r=t(16082),a=t(45507),d=t(88436),l=t(15324),m=t(52749),c=t(48966),u=t(75383),h=t(43411),p=t(79555),f=t(49882),b=t(63153),k=t(67193),g=t(80178),I=t(26327),w=t(22693),v=t(81552),_=t(33014),S=t(82907),A=t(25572),E=t(41450),y=t(86654),C=t(55554),F=t(54438),T=t(60177),M=t(2910),R=t(95638),x=t(64422),W=t(17778),P=t(88246),D=t(43570),q=t(73955);const G=["editFormEl"];function AddonModWorkshopEditSubmissionPage_form_16_ion_item_8_Template(e,o){if(1&e&&(F.j41(0,"ion-item")(1,"ion-label",13)(2,"div",14),F.EFF(3),F.nI1(4,"translate"),F.k0s()(),F.nrm(5,"core-rich-text-editor",15),F.nI1(6,"translate"),F.k0s()),2&e){const e=F.XpG(2);F.R7$(2),F.Y8G("core-mark-required",e.textRequired),F.R7$(),F.SpI(" ",F.bMT(4,9,"addon.mod_workshop.submissioncontent")," "),F.R7$(2),F.Y8G("control",e.editForm.controls.content)("placeholder",F.bMT(6,11,"addon.mod_workshop.submissioncontent"))("component",e.component)("componentId",e.componentId)("autoSave",!0)("contextInstanceId",e.module.id)("draftExtraParams",e.editorExtraParams)}}function AddonModWorkshopEditSubmissionPage_form_16_core_attachments_9_Template(e,o){if(1&e&&F.nrm(0,"core-attachments",16),2&e){const e=F.XpG(2);F.Y8G("files",e.attachments)("maxSize",e.workshop.maxbytes)("maxSubmissions",e.workshop.nattachments)("component",e.component)("componentId",e.workshop.coursemodule)("acceptedTypes",e.workshop.submissionfiletypes)("required",e.fileRequired)("courseId",e.workshop.course)}}function AddonModWorkshopEditSubmissionPage_form_16_Template(e,o){if(1&e&&(F.j41(0,"form",7,0)(2,"ion-item",8)(3,"ion-input",9),F.nI1(4,"translate"),F.j41(5,"div",10),F.EFF(6),F.nI1(7,"translate"),F.k0s()()(),F.DNE(8,AddonModWorkshopEditSubmissionPage_form_16_ion_item_8_Template,7,13,"ion-item",11)(9,AddonModWorkshopEditSubmissionPage_form_16_core_attachments_9_Template,1,8,"core-attachments",12),F.k0s()),2&e){const e=F.XpG();F.Y8G("formGroup",e.editForm),F.R7$(3),F.Y8G("placeholder",F.bMT(4,6,"addon.mod_workshop.submissiontitle")),F.R7$(2),F.Y8G("core-mark-required",!0),F.R7$(),F.SpI(" ",F.bMT(7,8,"addon.mod_workshop.submissiontitle")," "),F.R7$(2),F.Y8G("ngIf",e.textAvailable),F.R7$(),F.Y8G("ngIf",e.fileAvailable)}}let $=(()=>{var e;class AddonModWorkshopEditSubmissionPage{constructor(e){this.fb=e,this.loaded=!1,this.component=v.Ug,this.editorExtraParams={},this.textAvailable=!1,this.textRequired=!1,this.fileAvailable=!1,this.fileRequired=!1,this.attachments=[],this.submissionId=0,this.originalData={title:"",content:"",attachmentfiles:[]},this.hasOffline=!1,this.editing=!1,this.forceLeave=!1,this.isDestroyed=!1,this.userId=m.CoreSites.getCurrentSiteUserId(),this.siteId=m.CoreSites.getCurrentSiteId(),this.editForm=new s.gE({}),this.editForm.addControl("title",this.fb.control("",s.k0.required)),this.editForm.addControl("content",this.fb.control(""))}ngOnInit(){try{this.module=l.CoreNavigator.getRequiredRouteParam("module"),this.courseId=l.CoreNavigator.getRequiredRouteNumberParam("courseId"),this.access=l.CoreNavigator.getRequiredRouteParam("access"),this.submissionId=l.CoreNavigator.getRouteNumberParam("submissionId")||0}catch(e){return A.CoreAlerts.showError(e),l.CoreNavigator.back(),void 0}this.submissionId>0&&(this.editorExtraParams.id=this.submissionId),this.workshopId=this.module.instance,this.componentId=this.module.id,this.isDestroyed||c.CoreSync.blockOperation(v.Ug,this.workshopId),this.fetchSubmissionData()}canLeave(){var e=this;return(0,i.A)((function*(){var o;return e.forceLeave||(e.hasDataChanged()&&(yield A.CoreAlerts.confirmLeaveWithChanges()),null!==(o=e.submission)&&void 0!==o&&o.attachmentfiles&&r.CoreFileUploader.clearTmpFiles(e.submission.attachmentfiles),b.R.triggerFormCancelledEvent(e.formElement,e.siteId)),!0}))()}fetchSubmissionData(){var e=this;return(0,i.A)((function*(){try{if(e.workshop=yield k.AddonModWorkshop.getWorkshop(e.courseId,e.module.id),e.textAvailable=0!=e.workshop.submissiontypetext,e.textRequired=2==e.workshop.submissiontypetext,e.fileAvailable=0!=e.workshop.submissiontypefile,e.fileRequired=2==e.workshop.submissiontypefile,e.editForm.controls.content.setValidators(e.textRequired?s.k0.required:null),e.submissionId>0){e.editing=!0,e.submission=yield g.AddonModWorkshopHelper.getSubmissionById(e.workshopId,e.submissionId,{cmId:e.module.id,filter:!1,readingStrategy:3});if(!(e.userId==e.submission.authorid&&e.access.cansubmit&&e.access.modifyingsubmissionallowed))return e.forceLeavePage(),void 0}else if(!e.access.cansubmit||!e.access.creatingsubmissionallowed)return e.forceLeavePage(),void 0;const o=yield I.AddonModWorkshopOffline.getSubmissions(e.workshopId);o&&o.length?(e.hasOffline=!0,e.submission=yield g.AddonModWorkshopHelper.applyOfflineData(e.submission,o)):e.hasOffline=!1,e.submission&&(e.editForm.controls.title.setValue(e.submission.title),e.editForm.controls.content.setValue(d.CoreFileHelper.replacePluginfileUrls(e.submission.content,e.submission.contentfiles||[])),e.attachments=e.submission.attachmentfiles||[],e.originalData.title=e.editForm.controls.title.value,e.originalData.content=e.editForm.controls.content.value,e.originalData.attachmentfiles=[],(e.submission.attachmentfiles||[]).forEach((o=>{let t=a.CoreFile.getFileName(o);t||(t=d.CoreFileHelper.getFilenameFromPath(o)||""),e.originalData.attachmentfiles.push({filename:t,fileurl:"fileurl"in o?o.fileurl:""})}))),e.loaded=!0,e.logView()}catch(o){e.loaded=!1,A.CoreAlerts.showError(o,{default:p.HT.instant("core.course.errorgetmodule")}),e.forceLeavePage()}}))()}logView(){this.workshop&&w.OF.logEvent({type:w.qr.VIEW_ITEM,ws:this.editing?"mod_workshop_update_submission":"mod_workshop_add_submission",name:this.workshop.name,data:{id:this.workshop.id,submissionid:this.submissionId,category:"workshop"},url:`/mod/workshop/submission.php?cmid=${this.module.id}&id=${this.submissionId}&edit=on`})}forceLeavePage(){this.forceLeave=!0,l.CoreNavigator.back()}getInputData(){const e={title:this.editForm.value.title,content:"",attachmentfiles:[]};return this.textAvailable&&(e.content=this.editForm.value.content||""),this.fileAvailable&&(e.attachmentfiles=this.attachments),e}hasDataChanged(){if(!this.loaded)return!1;const e=this.getInputData();return!!(this.originalData.title!=e.title||this.textAvailable&&this.originalData.content!=e.content)||!!this.fileAvailable&&r.CoreFileUploader.areFileListDifferent(e.attachmentfiles,this.originalData.attachmentfiles)}save(){var e=this;return(0,i.A)((function*(){if(e.hasDataChanged())try{yield e.saveSubmission(),e.forceLeavePage()}catch{}else e.forceLeavePage()}))()}saveSubmission(){var e=this;return(0,i.A)((function*(){var o,t;const i=e.getInputData();if(!i.title)throw A.CoreAlerts.show({header:p.HT.instant("core.notice"),message:p.HT.instant("addon.mod_workshop.submissionrequiredtitle")}),new n.CoreError(p.HT.instant("addon.mod_workshop.submissionrequiredtitle"));const s=S.y.htmlIsBlank(i.content),a=!i.attachmentfiles.length;if(e.textRequired&&s||e.fileRequired&&a||s&&a)throw A.CoreAlerts.show({header:p.HT.instant("core.notice"),message:p.HT.instant("addon.mod_workshop.submissionrequiredcontent")}),new n.CoreError(p.HT.instant("addon.mod_workshop.submissionrequiredcontent"));let l=!1;const m=yield _.CoreLoadings.show("core.sending",!0),c=null===(o=e.submission)||void 0===o?void 0:o.id;i.content=d.CoreFileHelper.restorePluginfileUrls(i.content,(null===(t=e.submission)||void 0===t?void 0:t.contentfiles)||[]),e.textAvailable&&(i.content=u.Ni.formatHtmlLines(i.content));let w=!i.attachmentfiles.length;try{let o,t,s;try{o=yield g.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.workshopId,i.attachmentfiles,!1)}catch(o){if(h.CoreWSError.isWebServiceError(o))throw o;l=!0,w=!0,t=yield g.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.workshopId,i.attachmentfiles,!0)}if(l||e.fileAvailable||(o=void 0),e.editing)if(l)yield I.AddonModWorkshopOffline.saveSubmission(e.workshopId,e.courseId,i.title,i.content,t,c,"update"),s=!1;else{if(!c)throw new n.CoreError("Submission cannot be updated without a submissionId");s=yield k.AddonModWorkshop.updateSubmission(e.workshopId,c,e.courseId,i.title,i.content,o,void 0,w)}else l?(yield I.AddonModWorkshopOffline.saveSubmission(e.workshopId,e.courseId,i.title,i.content,t,void 0,"add"),s=!1):s=yield k.AddonModWorkshop.addSubmission(e.workshopId,e.courseId,i.title,i.content,o,void 0,w);b.R.triggerFormSubmittedEvent(e.formElement,!!s,e.siteId);const a={workshopId:e.workshopId};s&&(I.AddonModWorkshopOffline.deleteSubmissionAction(e.workshopId,e.editing?"update":"add"),g.AddonModWorkshopHelper.deleteSubmissionStoredFiles(e.workshopId,e.siteId),a.submissionId=s),f.z.trigger(f.z.ACTIVITY_DATA_SENT,{module:"workshop"}),s&&(yield C.g.ignoreErrors(k.AddonModWorkshop.invalidateSubmissionData(e.workshopId,s))),f.z.trigger(v.AZ,a,e.siteId),r.CoreFileUploader.clearTmpFiles(i.attachmentfiles)}catch(e){A.CoreAlerts.showError(e,{default:"Cannot save submission"})}finally{m.dismiss()}}))()}getFilesComponentId(){return`${this.workshopId}_${this.submissionId>0?this.submissionId:"newsub"}`}ngOnDestroy(){this.isDestroyed=!0,c.CoreSync.unblockOperation(v.Ug,this.workshopId)}}return(e=AddonModWorkshopEditSubmissionPage).ɵfac=function AddonModWorkshopEditSubmissionPage_Factory(o){return new(o||e)(F.rXU(s.ok))},e.ɵcmp=F.VBU({type:e,selectors:[["page-addon-mod-workshop-edit-submission"]],viewQuery:function AddonModWorkshopEditSubmissionPage_Query(e,o){if(1&e&&F.GBs(G,5),2&e){let e;F.mGM(e=F.lsd())&&(o.formElement=e.first)}},standalone:!0,features:[F.aNF],decls:17,vars:14,consts:[["editFormEl",""],["slot","start"],[3,"text"],["slot","end"],["fill","clear",3,"click","ariaLabel"],[3,"hideUntil"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],[1,"ion-text-wrap"],["labelPlacement","stacked","name","title","type","text","formControlName","title",3,"placeholder"],["slot","label",3,"core-mark-required"],[4,"ngIf"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId",4,"ngIf"],["position","stacked"],[3,"core-mark-required"],["name","content","contextLevel","module","elementId","content_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId"]],template:function AddonModWorkshopEditSubmissionPage_Template(e,o){1&e&&(F.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),F.nrm(3,"ion-back-button",2),F.nI1(4,"translate"),F.k0s(),F.j41(5,"ion-title")(6,"h1"),F.EFF(7),F.nI1(8,"translate"),F.k0s()(),F.j41(9,"ion-buttons",3)(10,"ion-button",4),F.nI1(11,"translate"),F.bIt("click",(function AddonModWorkshopEditSubmissionPage_Template_ion_button_click_10_listener(){return o.save()})),F.EFF(12),F.nI1(13,"translate"),F.k0s()()()(),F.j41(14,"ion-content")(15,"core-loading",5),F.DNE(16,AddonModWorkshopEditSubmissionPage_form_16_Template,10,10,"form",6),F.k0s()()),2&e&&(F.R7$(3),F.Y8G("text",F.bMT(4,6,"core.back")),F.R7$(4),F.JRh(F.bMT(8,8,"addon.mod_workshop.editsubmission")),F.R7$(3),F.Y8G("ariaLabel",F.bMT(11,10,"core.save")),F.R7$(2),F.SpI(" ",F.bMT(13,12,"core.save")," "),F.R7$(3),F.Y8G("hideUntil",o.loaded),F.R7$(),F.Y8G("ngIf",o.workshop))},dependencies:[y.n,T.bT,s.qT,s.BC,s.cb,M.Jm,M.QW,M.W9,M.eU,M.$w,M.uz,M.he,M.BC,M.ai,M.Gw,M.el,s.j4,s.JD,R.V,x.R,W.j,P.i,D.T,q.D9,E.CoreEditorRichTextEditorComponent],encapsulation:2}),AddonModWorkshopEditSubmissionPage})()}}]);