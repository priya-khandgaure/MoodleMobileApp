"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[45157],{45157:(e,s,t)=>{t.r(s),t.d(s,{AddonModWorkshopAssessmentStrategyComponent:()=>U});var o=t(10467),n=t(89417),a=t(75629),r=t(16082),d=t(45507),i=t(88436),l=t(24942),m=t(52749),c=t(48966),p=t(81690),h=t(79555),f=t(49882),_=t(63153),k=t(65964),u=t(67193),g=t(80178),A=t(26327),I=t(81552),y=t(91416),w=t(33014),b=t(55554),C=t(43411),S=t(58364),v=t(25572),F=t(41450),M=t(86654),T=t(54438),W=t(60177),x=t(2910),R=t(95638),G=t(68162),E=t(31498),$=t(25880),D=t(64422),O=t(17778),Y=t(58197),j=t(73955);const V=["assessmentForm"],_c1=e=>({$a:e}),_c2=e=>({asid:e}),_c3=e=>({header:e});function AddonModWorkshopAssessmentStrategyComponent_ng_container_6_Template(e,s){if(1&e&&(T.qex(0),T.nrm(1,"core-dynamic-component",6),T.bVm()),2&e){const e=T.XpG();T.R7$(),T.Y8G("component",e.componentClass)("data",e.data)}}function AddonModWorkshopAssessmentStrategyComponent_ion_card_7_Template(e,s){if(1&e&&(T.j41(0,"ion-card",7)(1,"ion-item")(2,"ion-label")(3,"p"),T.EFF(4),T.nI1(5,"translate"),T.k0s()()()()),2&e){const e=T.XpG();T.R7$(4),T.JRh(T.i5U(5,1,"addon.mod_workshop.assessmentstrategynotsupported",T.eq3(4,_c1,e.strategy)))}}function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_core_input_errors_6_Template(e,s){if(1&e&&T.nrm(0,"core-input-errors",16),2&e){const e=T.XpG(3);T.Y8G("errorText",e.data.fieldErrors.feedbackauthor)}}function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_Template(e,s){if(1&e){const e=T.RV6();T.j41(0,"ion-item")(1,"ion-label",12)(2,"span",13),T.EFF(3),T.nI1(4,"translate"),T.k0s()(),T.j41(5,"core-rich-text-editor",14),T.bIt("contentChanged",(function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_Template_core_rich_text_editor_contentChanged_5_listener(s){T.eBV(e);const t=T.XpG(2);return T.Njj(t.onFeedbackChange(s))})),T.k0s(),T.DNE(6,AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_core_input_errors_6_Template,1,1,"core-input-errors",15),T.k0s()}if(2&e){const e=T.XpG(2);T.R7$(2),T.Y8G("core-mark-required",e.overallFeedkbackRequired),T.R7$(),T.SpI(" ",T.bMT(4,9,"addon.mod_workshop.feedbackauthor")," "),T.R7$(2),T.Y8G("control",e.feedbackControl)("component",e.component)("componentId",e.workshop.coursemodule)("autoSave",!0)("contextInstanceId",e.workshop.coursemodule)("draftExtraParams",T.eq3(11,_c2,e.assessmentId)),T.R7$(),T.Y8G("ngIf",e.overallFeedkbackRequired&&e.data.fieldErrors&&e.data.fieldErrors.feedbackauthor)}}function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_core_attachments_7_Template(e,s){if(1&e&&T.nrm(0,"core-attachments",17),2&e){const e=T.XpG(2);T.Y8G("files",null==e.data.assessment?null:e.data.assessment.feedbackattachmentfiles)("maxSize",e.workshop.overallfeedbackmaxbytes)("maxSubmissions",e.workshop.overallfeedbackfiles)("component",e.component)("componentId",e.componentId)("allowOffline",!0)("courseId",e.workshop.course)}}function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_ion_select_option_7_Template(e,s){if(1&e&&(T.j41(0,"ion-select-option",21),T.EFF(1),T.k0s()),2&e){const e=s.$implicit;T.Y8G("value",e),T.R7$(),T.JRh(e)}}function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_Template(e,s){if(1&e){const e=T.RV6();T.j41(0,"ion-item")(1,"ion-select",18),T.nI1(2,"translate"),T.nI1(3,"translate"),T.mxI("ngModelChange",(function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_Template_ion_select_ngModelChange_1_listener(s){T.eBV(e);const t=T.XpG(2);return T.DH7(t.weight,s)||(t.weight=s),T.Njj(s)})),T.j41(4,"div",19),T.EFF(5),T.nI1(6,"translate"),T.k0s(),T.DNE(7,AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_ion_select_option_7_Template,2,2,"ion-select-option",20),T.k0s()()}if(2&e){const e=T.XpG(2);T.R7$(),T.R50("ngModel",e.weight),T.Y8G("cancelText",T.bMT(2,6,"core.cancel"))("interfaceOptions",T.eq3(12,_c3,T.bMT(3,8,"addon.mod_workshop.assessmentweight"))),T.R7$(3),T.Y8G("core-mark-required",!0),T.R7$(),T.SpI(" ",T.bMT(6,10,"addon.mod_workshop.assessmentweight")," "),T.R7$(2),T.Y8G("ngForOf",e.weights)}}function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_9_Template(e,s){if(1&e&&(T.j41(0,"ion-item",8)(1,"ion-label"),T.nrm(2,"core-format-text",22),T.k0s()()),2&e){const e=T.XpG(2);T.R7$(2),T.Y8G("component",e.component)("componentId",e.componentId)("text",null==e.data.assessment?null:e.data.assessment.feedbackauthor)("contextInstanceId",e.workshop.coursemodule)("courseId",e.workshop.course)}}function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_10_Template(e,s){if(1&e&&(T.j41(0,"ion-item")(1,"ion-label"),T.nrm(2,"core-files",23),T.k0s()()),2&e){const e=T.XpG(2);T.R7$(2),T.Y8G("files",null==e.data.assessment?null:e.data.assessment.feedbackattachmentfiles)("component",e.component)("componentId",e.componentId)}}function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_Template(e,s){if(1&e&&(T.j41(0,"ion-card")(1,"ion-item",8)(2,"ion-label")(3,"h3",9),T.EFF(4),T.nI1(5,"translate"),T.k0s()()(),T.DNE(6,AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_Template,7,13,"ion-item",4)(7,AddonModWorkshopAssessmentStrategyComponent_ion_card_8_core_attachments_7_Template,1,7,"core-attachments",10)(8,AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_Template,8,14,"ion-item",4)(9,AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_9_Template,3,5,"ion-item",11)(10,AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_10_Template,3,3,"ion-item",4),T.k0s()),2&e){const e=T.XpG();T.R7$(4),T.JRh(T.bMT(5,6,"addon.mod_workshop.overallfeedback")),T.R7$(2),T.Y8G("ngIf",e.edit),T.R7$(),T.Y8G("ngIf",e.edit&&e.workshop.overallfeedbackfiles),T.R7$(),T.Y8G("ngIf",e.edit&&e.access&&e.access.canallocate),T.R7$(),T.Y8G("ngIf",!e.edit&&(null==e.data.assessment?null:e.data.assessment.feedbackauthor)),T.R7$(),T.Y8G("ngIf",!e.edit&&e.workshop.overallfeedbackfiles&&(null==e.data.assessment||null==e.data.assessment.feedbackattachmentfiles?null:e.data.assessment.feedbackattachmentfiles.length))}}let U=(()=>{var e;class AddonModWorkshopAssessmentStrategyComponent{constructor(){this.edit=!1,this.data={workshopId:0,assessment:void 0,edit:!1,selectedValues:[],fieldErrors:{},strategy:"",moduleId:0,courseId:void 0},this.assessmentStrategyLoaded=!1,this.notSupported=!1,this.feedbackText="",this.feedbackControl=new n.MJ(null),this.overallFeedkback=!1,this.overallFeedkbackRequired=!1,this.component=I.Ug,this.weights=[],this.hasOffline=!1,this.originalData={text:"",files:[],weight:1,selectedValues:[]}}ngOnInit(){var e=this;return(0,o.A)((function*(){if(!e.assessmentId||!e.strategy)return e.assessmentStrategyLoaded=!0,void 0;if(e.data.workshopId=e.workshop.id,e.data.edit=e.edit,e.data.strategy=e.strategy,e.data.moduleId=e.workshop.coursemodule,e.data.courseId=e.workshop.course,e.componentClass=yield k.AddonWorkshopAssessmentStrategyDelegate.getComponentForPlugin(e.strategy),e.componentClass){if(e.overallFeedkback=0!=e.workshop.overallfeedbackmode,e.overallFeedkbackRequired=2==e.workshop.overallfeedbackmode,e.componentId=e.workshop.coursemodule,e.edit&&e.access.canallocate){e.weights=[];for(let s=16;s>=0;s--)e.weights[s]=s}e.edit&&c.CoreSync.blockOperation(I.Ug,e.workshop.id);try{yield e.load(),e.obsInvalidated=f.z.on(I.Dl,(()=>e.load()),m.CoreSites.getCurrentSiteId())}catch(s){e.componentClass=void 0,v.CoreAlerts.showError(s,{default:"Error loading assessment."})}finally{e.assessmentStrategyLoaded=!0}}else e.notSupported=!k.AddonWorkshopAssessmentStrategyDelegate.isPluginSupported(e.strategy),e.assessmentStrategyLoaded=!0}))()}load(){var e=this;return(0,o.A)((function*(){if(e.data.assessment=yield g.AddonModWorkshopHelper.getReviewerAssessmentById(e.workshop.id,e.assessmentId,{userId:e.userId,cmId:e.workshop.coursemodule,filter:!e.edit&&void 0,readingStrategy:e.edit?3:void 0}),e.data.assessment.form){if(e.edit)try{const s=(yield A.AddonModWorkshopOffline.getAssessment(e.workshop.id,e.assessmentId)).inputdata;e.hasOffline=!0,e.data.assessment.feedbackauthor=s.feedbackauthor,e.access.canallocate&&(e.data.assessment.weight=s.weight),e.data.assessment.form.current=u.AddonModWorkshop.parseFields(S.T.toArrayOfObjects(s,"name","value")),s&&(e.data.assessment.feedbackattachmentfiles=yield g.AddonModWorkshopHelper.getAssessmentFilesFromOfflineFilesObject(s.feedbackauthorattachmentsid,e.workshop.id,e.assessmentId))}catch{e.hasOffline=!1}finally{e.feedbackText=i.CoreFileHelper.replacePluginfileUrls(e.data.assessment.feedbackauthor,e.data.assessment.feedbackcontentfiles),e.feedbackControl.setValue(e.feedbackText),e.originalData.text=e.data.assessment.feedbackauthor,e.access.canallocate&&(e.originalData.weight=e.data.assessment.weight),e.originalData.files=[],e.data.assessment.feedbackattachmentfiles.forEach((s=>{let t=d.CoreFile.getFileName(s);t||(t=i.CoreFileHelper.getFilenameFromPath(s)||""),e.originalData.files.push({filename:t,fileurl:""})}))}try{e.data.selectedValues=yield k.AddonWorkshopAssessmentStrategyDelegate.getOriginalValues(e.strategy,e.data.assessment.form,e.workshop.id)}finally{e.originalData.selectedValues=p.j.clone(e.data.selectedValues),e.edit&&(l.CoreFileSession.setFiles(I.Ug,`${e.workshop.id}_${e.assessmentId}`,e.data.assessment.feedbackattachmentfiles),e.access.canallocate&&(e.weight=e.data.assessment.weight))}}}))()}hasDataChanged(){var e=this;return(0,o.A)((function*(){var s;if(!e.assessmentStrategyLoaded||!e.workshop.strategy||!e.edit)return!1;const t=i.CoreFileHelper.restorePluginfileUrls(e.feedbackText,(null===(s=e.data.assessment)||void 0===s?void 0:s.feedbackcontentfiles)||[]);if(e.originalData.text!=t)return!0;if(e.access.canallocate&&e.originalData.weight!=e.weight)return!0;const o=l.CoreFileSession.getFiles(I.Ug,`${e.workshop.id}_${e.assessmentId}`)||[];return!!r.CoreFileUploader.areFileListDifferent(o,e.originalData.files)||(yield k.AddonWorkshopAssessmentStrategyDelegate.hasDataChanged(e.workshop.strategy,e.originalData.selectedValues,e.data.selectedValues))}))()}saveAssessment(){var e=this;return(0,o.A)((function*(){var s;if(null===(s=e.data.assessment)||void 0===s||!s.form)return;const t=l.CoreFileSession.getFiles(I.Ug,`${e.workshop.id}_${e.assessmentId}`)||[];let o=!1,n=!t.length;const d=yield w.CoreLoadings.show("core.sending",!0);e.data.fieldErrors={};try{var c;let s;try{s=yield g.AddonModWorkshopHelper.uploadOrStoreAssessmentFiles(e.workshop.id,e.assessmentId,t,o)}catch(a){if(C.CoreWSError.isWebServiceError(a))throw a;o=!0,n=!0,s=yield g.AddonModWorkshopHelper.uploadOrStoreAssessmentFiles(e.workshop.id,e.assessmentId,t,o)}const d=i.CoreFileHelper.restorePluginfileUrls(e.feedbackText,(null===(c=e.data.assessment)||void 0===c?void 0:c.feedbackcontentfiles)||[]);let l;try{l=yield g.AddonModWorkshopHelper.prepareAssessmentData(e.workshop,e.data.selectedValues,d,e.data.assessment.form,s)}catch(s){throw e.data.fieldErrors=s,new a.CoreError(h.HT.instant("core.errorinvalidform"))}let p=!1;o?yield A.AddonModWorkshopOffline.saveAssessment(e.workshop.id,e.assessmentId,e.workshop.course,l):p=yield u.AddonModWorkshop.updateAssessment(e.workshop.id,e.assessmentId,e.workshop.course,l,void 0,n),_.R.triggerFormSubmittedEvent(e.formElement,!!p,m.CoreSites.getCurrentSiteId());const k=[];p&&(k.push(g.AddonModWorkshopHelper.deleteAssessmentStoredFiles(e.workshop.id,e.assessmentId)),k.push(u.AddonModWorkshop.invalidateAssessmentFormData(e.workshop.id,e.assessmentId)),k.push(u.AddonModWorkshop.invalidateAssessmentData(e.workshop.id,e.assessmentId))),yield b.g.ignoreErrors(Promise.all(k)),f.z.trigger(I.Px,{workshopId:e.workshop.id,assessmentId:e.assessmentId,userId:m.CoreSites.getCurrentSiteUserId()},m.CoreSites.getCurrentSiteId()),t&&r.CoreFileUploader.clearTmpFiles(t)}catch(e){v.CoreAlerts.showError(e,{default:"Error saving assessment."})}finally{d.dismiss()}}))()}onFeedbackChange(e){this.feedbackText=null!=e?e:""}ngOnDestroy(){var e,s;null===(e=this.obsInvalidated)||void 0===e||e.off(),null!==(s=this.data.assessment)&&void 0!==s&&s.feedbackattachmentfiles&&r.CoreFileUploader.clearTmpFiles(this.data.assessment.feedbackattachmentfiles)}}return(e=AddonModWorkshopAssessmentStrategyComponent).ɵfac=function AddonModWorkshopAssessmentStrategyComponent_Factory(s){return new(s||e)},e.ɵcmp=T.VBU({type:e,selectors:[["addon-mod-workshop-assessment-strategy"]],viewQuery:function AddonModWorkshopAssessmentStrategyComponent_Query(e,s){if(1&e&&T.GBs(V,5),2&e){let e;T.mGM(e=T.lsd())&&(s.formElement=e.first)}},inputs:{workshop:"workshop",access:"access",assessmentId:"assessmentId",userId:"userId",strategy:"strategy",edit:[T.Mj6.HasDecoratorInputTransform,"edit","edit",y.G]},standalone:!0,features:[T.GFd,T.aNF],decls:9,vars:7,consts:[["assessmentForm",""],[1,"ion-padding"],["name","mma-mod_workshop-assessment-form"],[3,"hideUntil"],[4,"ngIf"],["class","core-info-card",4,"ngIf"],[3,"component","data"],[1,"core-info-card"],[1,"ion-text-wrap"],[1,"item-heading"],[3,"files","maxSize","maxSubmissions","component","componentId","allowOffline","courseId",4,"ngIf"],["class","ion-text-wrap",4,"ngIf"],["position","stacked"],[3,"core-mark-required"],["contextLevel","module","elementId","feedbackauthor_editor",3,"contentChanged","control","component","componentId","autoSave","contextInstanceId","draftExtraParams"],[3,"errorText",4,"ngIf"],[3,"errorText"],[3,"files","maxSize","maxSubmissions","component","componentId","allowOffline","courseId"],["labelPlacement","stacked","interface","action-sheet","name","weight",3,"ngModelChange","ngModel","cancelText","interfaceOptions"],["slot","label",3,"core-mark-required"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["contextLevel","module",3,"component","componentId","text","contextInstanceId","courseId"],[3,"files","component","componentId"]],template:function AddonModWorkshopAssessmentStrategyComponent_Template(e,s){1&e&&(T.j41(0,"h2",1),T.EFF(1),T.nI1(2,"translate"),T.k0s(),T.j41(3,"form",2,0)(5,"core-loading",3),T.DNE(6,AddonModWorkshopAssessmentStrategyComponent_ng_container_6_Template,2,2,"ng-container",4)(7,AddonModWorkshopAssessmentStrategyComponent_ion_card_7_Template,6,6,"ion-card",5)(8,AddonModWorkshopAssessmentStrategyComponent_ion_card_8_Template,11,8,"ion-card",4),T.k0s()()),2&e&&(T.R7$(),T.JRh(T.bMT(2,5,"addon.mod_workshop.assessmentform")),T.R7$(4),T.Y8G("hideUntil",s.assessmentStrategyLoaded),T.R7$(),T.Y8G("ngIf",s.componentClass&&s.assessmentStrategyLoaded),T.R7$(),T.Y8G("ngIf",s.notSupported),T.R7$(),T.Y8G("ngIf",s.assessmentStrategyLoaded&&s.overallFeedkback&&(s.edit||(null==s.data.assessment?null:s.data.assessment.feedbackauthor)||(null==s.data.assessment||null==s.data.assessment.feedbackattachmentfiles?null:s.data.assessment.feedbackattachmentfiles.length))))},dependencies:[M.n,W.Sq,W.bT,n.qT,n.BC,n.cb,n.vS,n.cV,x.b_,x.uz,x.he,x.Nm,x.Ip,x.Je,R.V,G.m,E.Y,$.q,D.R,O.j,Y.B,j.D9,F.CoreEditorRichTextEditorComponent],encapsulation:2}),AddonModWorkshopAssessmentStrategyComponent})()}}]);